<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">تحميل المنتج... - سوق الإمارات</title>
    <meta name="description" content="" id="pageDescription">
    
    <!-- Dynamic SEO Meta Tags -->
    <meta name="keywords" content="" id="pageKeywords">
    <meta name="robots" content="index, follow">
    <meta name="author" content="سوق الإمارات">
    <link rel="canonical" href="" id="pageCanonical">
    
    <!-- Open Graph -->
    <meta property="og:type" content="product">
    <meta property="og:title" content="" id="ogTitle">
    <meta property="og:description" content="" id="ogDescription">
    <meta property="og:url" content="" id="ogUrl">
    <meta property="og:site_name" content="سوق الإمارات">
    <meta property="og:locale" content="ar_AE">
    <meta property="og:image" content="" id="ogImage">
    
    <!-- Language Alternatives -->
    <link rel="alternate" hreflang="en-AE" href="" id="hreflangEn">
    <link rel="alternate" hreflang="ar-AE" href="" id="hreflangAr">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico">
    <link rel="apple-touch-icon" href="assets/img/apple-touch-icon.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/theme-3d.css">
    <link rel="stylesheet" href="assets/css/responsive.css">
    
    <!-- Product-specific styles -->
    <style>
        .product-hero {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: var(--spacing-2xl) 0;
            margin-bottom: var(--spacing-2xl);
        }
        
        .product-main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-2xl);
            margin-bottom: var(--spacing-3xl);
        }
        
        .product-gallery {
            position: relative;
        }
        
        .product-main-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            margin-bottom: var(--spacing-md);
        }
        
        .product-info {
            background: var(--white);
            padding: var(--spacing-2xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
        }
        
        .product-title-main {
            font-size: var(--text-3xl);
            color: var(--primary-color);
            margin-bottom: var(--spacing-lg);
            line-height: 1.3;
        }
        
        .product-price-main {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-lg);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
        }
        
        .price-main-current {
            font-size: var(--text-4xl);
            font-weight: 900;
            color: var(--success-color);
        }
        
        .price-main-original {
            font-size: var(--text-2xl);
            color: var(--gray-500);
            text-decoration: line-through;
        }
        
        .discount-main {
            background: var(--error-color);
            color: var(--white);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-lg);
            font-weight: 700;
            font-size: var(--text-lg);
        }
        
        .product-features-main {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xl);
        }
        
        .feature-main {
            background: var(--primary-color);
            color: var(--white);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-lg);
            font-size: var(--text-sm);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .product-description-main {
            line-height: 1.8;
            color: var(--gray-700);
            margin-bottom: var(--spacing-xl);
        }
        
        .breadcrumb {
            background: var(--white);
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .breadcrumb-list {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            list-style: none;
            font-size: var(--text-sm);
        }
        
        .breadcrumb-item {
            color: var(--gray-600);
        }
        
        .breadcrumb-item a {
            color: var(--primary-color);
        }
        
        .breadcrumb-separator {
            color: var(--gray-400);
            margin: 0 var(--spacing-xs);
        }
        
        .related-products {
            background: var(--gray-50);
            padding: var(--spacing-3xl) 0;
        }
        
        @media (max-width: 768px) {
            .product-main {
                grid-template-columns: 1fr;
                gap: var(--spacing-lg);
            }
            
            .product-main-image {
                height: 300px;
            }
            
            .product-info {
                padding: var(--spacing-lg);
            }
            
            .product-title-main {
                font-size: var(--text-xl);
            }
            
            .price-main-current {
                font-size: var(--text-2xl);
            }
        }
    </style>
</head>
<body class="rtl-layout">
    <!-- Header -->
    <header class="main-header glass-effect">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <a href="./" style="text-decoration: none; color: inherit;">
                        <h1 class="logo">🛒 سوق الإمارات</h1>
                    </a>
                </div>
                
                <div class="search-container">
                    <div class="search-wrapper floating-3d">
                        <input type="text" id="searchInput" placeholder="ابحث عن منتجاتك المفضلة..." class="search-input">
                        <button class="search-btn" onclick="performSearch()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="header-actions">
                    <div class="language-switcher">
                        <a href="en/" class="lang-btn floating-3d">English</a>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <div class="container">
            <nav class="breadcrumb-nav">
                <ol class="breadcrumb-list" id="breadcrumbList">
                    <li class="breadcrumb-item"><a href="./">الرئيسية</a></li>
                    <li class="breadcrumb-separator">/</li>
                    <li class="breadcrumb-item" id="categoryBreadcrumb">...</li>
                    <li class="breadcrumb-separator">/</li>
                    <li class="breadcrumb-item" id="productBreadcrumb">...</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <!-- Product Main Content -->
    <main class="product-page">
        <div class="container">
            <div class="product-main" id="productMain">
                <div class="product-gallery">
                    <img id="productMainImage" src="" alt="" class="product-main-image floating-3d">
                </div>
                
                <div class="product-info floating-3d">
                    <h1 class="product-title-main" id="productTitle">...</h1>
                    
                    <div class="product-price-main" id="productPrice">
                        <!-- Price will be loaded dynamically -->
                    </div>
                    
                    <div class="product-features-main" id="productFeatures">
                        <!-- Features will be loaded dynamically -->
                    </div>
                    
                    <div class="product-rating" id="productRating">
                        <!-- Rating will be loaded dynamically -->
                    </div>
                    
                    <div class="product-description-main" id="productDescription">
                        <!-- Description will be loaded dynamically -->
                    </div>
                    
                    <div class="product-actions">
                        <button class="btn-3d" style="background: var(--success-color); color: white; padding: var(--spacing-lg) var(--spacing-2xl); border: none; border-radius: var(--radius-lg); font-size: var(--text-lg); font-weight: 600; width: 100%; margin-bottom: var(--spacing-md);">
                            📞 اتصل للطلب الآن
                        </button>
                        <p style="text-align: center; color: var(--gray-600); font-size: var(--text-sm);">
                            🚚 التوصيل في 1-3 أيام عمل | 💰 دفع عند الاستلام
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Related Products Section -->
    <section class="related-products">
        <div class="container">
            <h2 class="section-title">منتجات مشابهة</h2>
            <div class="products-grid" id="relatedProductsGrid">
                <!-- Related products will be loaded dynamically -->
            </div>
        </div>
    </section>
    
    <!-- Footer -->
    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3 class="footer-title">سوق الإمارات</h3>
                    <p class="footer-description">منصتك الموثوقة للتسوق الإلكتروني في دولة الإمارات العربية المتحدة</p>
                </div>
                
                <div class="footer-section">
                    <h4 class="footer-subtitle">خدمة العملاء</h4>
                    <ul class="footer-links">
                        <li><a href="#">تواصل معنا</a></li>
                        <li><a href="#">الأسئلة الشائعة</a></li>
                        <li><a href="#">سياسة الإرجاع</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4 class="footer-subtitle">معلومات الشحن</h4>
                    <ul class="footer-info">
                        <li>⏱️ التوصيل: 1-3 أيام عمل</li>
                        <li>💰 دفع عند الاستلام متاح</li>
                        <li>📦 شحن مجاني للطلبات +100 درهم</li>
                        <li>↩️ إرجاع مجاني خلال 14 يوم</li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 سوق الإمارات. جميع الحقوق محفوظة.</p>
                <div class="footer-links">
                    <a href="#">الشروط والأحكام</a> |
                    <a href="#">سياسة الخصوصية</a> |
                    <a href="en/product.html" id="englishLink">English</a>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner hidden">
        <div class="spinner-3d"></div>
        <p>جاري التحميل...</p>
    </div>
    
    <!-- Scripts -->
    <script src="assets/js/data-loader.js"></script>
    <script src="assets/js/seo.js"></script>
    
    <!-- Product Page Logic -->
    <script>
        let currentProduct = null;
        let allProducts = [];
        
        // Initialize product page
        document.addEventListener('DOMContentLoaded', function() {
            loadProductData();
        });
        
        // Load product data
        async function loadProductData() {
            try {
                showLoadingSpinner(true);
                
                const response = await fetch('./data/uae-products.json');
                const products = await response.json();
                allProducts = products;
                
                // Get product ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get('id');
                const productSlug = urlParams.get('slug');
                
                if (productId) {
                    currentProduct = products.find(p => p.id === productId);
                } else if (productSlug) {
                    currentProduct = products.find(p => p.url_slug === productSlug || createSlug(p.title) === productSlug);
                }
                
                if (currentProduct) {
                    displayProduct(currentProduct);
                    loadRelatedProducts(currentProduct);
                    updateSEO(currentProduct);
                } else {
                    showProductNotFound();
                }
                
            } catch (error) {
                console.error('Error loading product:', error);
                showProductNotFound();
            } finally {
                showLoadingSpinner(false);
            }
        }
        
        // Display product information
        function displayProduct(product) {
            // Update main content
            document.getElementById('productTitle').textContent = product.title;
            document.getElementById('productMainImage').src = product.image_url;
            document.getElementById('productMainImage').alt = product.title;
            
            // Price section
            const priceSection = document.getElementById('productPrice');
            const hasDiscount = product.regular_price > product.sale_price;
            const discountPercentage = hasDiscount ? Math.round(((product.regular_price - product.sale_price) / product.regular_price) * 100) : 0;
            
            priceSection.innerHTML = `
                <div class="price-main-current">${product.sale_price} ${product.currency}</div>
                ${hasDiscount ? `<div class="price-main-original">${product.regular_price} ${product.currency}</div>` : ''}
                ${hasDiscount ? `<div class="discount-main">-${discountPercentage}%</div>` : ''}
            `;
            
            // Features
            const featuresSection = document.getElementById('productFeatures');
            const features = [];
            
            if (product.cod_available) features.push('<div class="feature-main">💰 دفع عند الاستلام</div>');
            if (product.delivery_time) features.push(`<div class="feature-main">🚚 ${product.delivery_time}</div>`);
            if (product.uae_compliant) features.push('<div class="feature-main">🇦🇪 متوافق مع الإمارات</div>');
            if (product.material) features.push(`<div class="feature-main">🔍 خامة: ${product.material}</div>`);
            
            featuresSection.innerHTML = features.join('');
            
            // Rating
            const ratingSection = document.getElementById('productRating');
            if (product.average_rating && product.review_count) {
                ratingSection.innerHTML = `
                    <div class="rating-stars">${generateStars(product.average_rating)}</div>
                    <div class="rating-count">${product.average_rating}/5 (${product.review_count} تقييم)</div>
                `;
                ratingSection.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: var(--spacing-md);
                    padding: var(--spacing-md);
                    background: var(--gray-50);
                    border-radius: var(--radius-lg);
                    margin-bottom: var(--spacing-lg);
                `;
            }
            
            // Description
            const descriptionSection = document.getElementById('productDescription');
            descriptionSection.innerHTML = formatDescription(product.description);
            
            // Breadcrumb
            updateBreadcrumb(product);
        }
        
        // Format product description
        function formatDescription(description) {
            if (!description) return '';
            
            // Convert basic formatting
            let formatted = description
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>')
                .replace(/&nbsp;/g, ' ');
            
            // Create paragraphs from double line breaks
            const paragraphs = formatted.split('<br><br>');
            return paragraphs.map(p => `<p>${p}</p>`).join('');
        }
        
        // Generate star rating
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            let stars = '⭐'.repeat(fullStars);
            if (hasHalfStar) stars += '⭐';
            stars += '☆'.repeat(emptyStars);
            
            return stars;
        }
        
        // Update breadcrumb
        function updateBreadcrumb(product) {
            document.getElementById('categoryBreadcrumb').innerHTML = `
                <a href="./?category=${encodeURIComponent(product.category)}">${product.category}</a>
            `;
            document.getElementById('productBreadcrumb').textContent = product.title;
        }
        
        // Load related products
        function loadRelatedProducts(product) {
            const related = allProducts
                .filter(p => p.id !== product.id && p.category === product.category)
                .slice(0, 4);
            
            const relatedGrid = document.getElementById('relatedProductsGrid');
            relatedGrid.innerHTML = '';
            
            related.forEach(relatedProduct => {
                const card = createProductCard(relatedProduct);
                relatedGrid.appendChild(card);
            });
        }
        
        // Create product card (reuse from data-loader.js)
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card floating-3d';
            card.onclick = () => goToProduct(product);
            
            const discountPercentage = product.discount_percentage || 
                Math.round(((product.regular_price - product.sale_price) / product.regular_price) * 100);
            
            const hasDiscount = discountPercentage > 0;
            
            card.innerHTML = `
                <div class="product-image-container">
                    <img src="${product.image_url}" 
                         alt="${product.title}" 
                         class="product-image"
                         loading="lazy"
                         onerror="this.src='assets/img/placeholder.webp'">
                    ${hasDiscount ? `<span class="discount-badge">-${discountPercentage}%</span>` : ''}
                </div>
                
                <div class="product-content">
                    <h3 class="product-title">${product.title}</h3>
                    <div class="product-price">
                        <span class="price-current">${product.sale_price} ${product.currency}</span>
                        ${hasDiscount ? `<span class="price-original">${product.regular_price} ${product.currency}</span>` : ''}
                    </div>
                </div>
            `;
            
            return card;
        }
        
        // Go to product
        function goToProduct(product) {
            const slug = product.url_slug || createSlug(product.title);
            window.location.href = `product.html?id=${product.id}&slug=${slug}`;
        }
        
        // Create slug
        function createSlug(title) {
            return title
                .toLowerCase()
                .replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\u0590-\u05FF\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
        }
        
        // Update SEO meta tags
        function updateSEO(product) {
            document.getElementById('pageTitle').textContent = product.seo_title || `${product.title} - سوق الإمارات`;
            document.title = product.seo_title || `${product.title} - سوق الإمارات`;
            
            const description = product.meta_description || product.description.substring(0, 160);
            document.getElementById('pageDescription').content = description;
            
            document.getElementById('pageKeywords').content = product.seo_keywords || '';
            
            const currentUrl = window.location.href;
            document.getElementById('pageCanonical').href = currentUrl;
            document.getElementById('ogUrl').content = currentUrl;
            document.getElementById('ogTitle').content = product.title;
            document.getElementById('ogDescription').content = description;
            document.getElementById('ogImage').content = product.image_url;
            
            // Update hreflang
            const slug = product.url_slug || createSlug(product.title);
            document.getElementById('hreflangAr').href = currentUrl;
            document.getElementById('hreflangEn').href = `en/product.html?id=${product.id}&slug=${slug}`;
            document.getElementById('englishLink').href = `en/product.html?id=${product.id}&slug=${slug}`;
            
            // Add product schema
            addProductSchema(product);
        }
        
        // Add product structured data
        function addProductSchema(product) {
            const schema = {
                "@context": "https://schema.org",
                "@type": "Product",
                "name": product.title,
                "description": product.description,
                "image": product.image_url,
                "brand": {
                    "@type": "Brand",
                    "name": product.brand || "سوق الإمارات"
                },
                "offers": {
                    "@type": "Offer",
                    "price": product.sale_price,
                    "priceCurrency": product.currency,
                    "availability": product.stock_status === 'in stock' ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
                    "priceValidUntil": "2025-12-31",
                    "itemCondition": "https://schema.org/NewCondition"
                },
                "category": product.category,
                "sku": product.id
            };
            
            if (product.average_rating && product.review_count) {
                schema.aggregateRating = {
                    "@type": "AggregateRating",
                    "ratingValue": product.average_rating,
                    "reviewCount": product.review_count
                };
            }
            
            const script = document.createElement('script');
            script.type = 'application/ld+json';
            script.textContent = JSON.stringify(schema);
            document.head.appendChild(script);
        }
        
        // Show product not found
        function showProductNotFound() {
            document.getElementById('productMain').innerHTML = `
                <div style="text-align: center; padding: var(--spacing-3xl); grid-column: 1 / -1;">
                    <h1 style="color: var(--error-color); margin-bottom: var(--spacing-lg);">لم يتم العثور على المنتج</h1>
                    <p style="margin-bottom: var(--spacing-xl);">المنتج المطلوب غير موجود أو تم حذفه.</p>
                    <a href="./" class="btn-3d" style="background: var(--primary-color); color: white; padding: var(--spacing-md) var(--spacing-xl); border-radius: var(--radius-lg); text-decoration: none; display: inline-block;">عودة إلى الرئيسية</a>
                </div>
            `;
        }
        
        // Search functionality
        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
                window.location.href = `./?q=${encodeURIComponent(query)}`;
            }
        }
        
        // Loading spinner
        function showLoadingSpinner(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) {
                spinner.classList.toggle('hidden', !show);
            }
        }
    </script>
</body>
</html>