<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💳 إتمام الطلب - سوق الإمارات للهدايا</title>
    <meta name="description" content="إتمام الطلب في سوق الإمارات بأمان وسهولة. دفع عند الاستلام، شحن مجاني، ضمان إرجاع">
    <meta name="robots" content="noindex, nofollow">
    
    <link rel="icon" type="image/png" href="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/e1029c77-e4a0-4b40-a278-4b4996e2ee05.png">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/dkhoon-inspired-theme.css">
    
    <style>
        .checkout-page {
            min-height: 100vh;
            padding: 120px 0 0;
            background: var(--bg-primary);
        }
        
        .checkout-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 3rem;
        }
        
        .checkout-form {
            background: var(--bg-card);
            border-radius: 25px;
            padding: 3rem;
            box-shadow: var(--shadow-elegant);
            border: 3px solid var(--gold-light);
        }
        
        .checkout-summary {
            background: var(--gradient-pearl);
            border-radius: 25px;
            padding: 2.5rem;
            box-shadow: var(--shadow-gold);
            border: 3px solid var(--gold-primary);
            height: fit-content;
            position: sticky;
            top: 140px;
        }
        
        .page-title {
            font-size: 2.5rem;
            font-weight: 900;
            background: var(--gradient-gold);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .security-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            background: rgba(80, 200, 120, 0.1);
            border: 2px solid var(--emerald-green);
            border-radius: 15px;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            color: var(--emerald-green);
            font-weight: 700;
        }
        
        .form-section {
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            border-right: 4px solid var(--gold-primary);
            padding-right: 1rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .required {
            color: #EF4444;
            font-weight: 900;
        }
        
        .form-input {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            font-size: 1rem;
            background: white;
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-family: 'Cairo', sans-serif;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--gold-primary);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .form-input.error {
            border-color: #EF4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }
        
        .error-message {
            color: #EF4444;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            font-weight: 600;
        }
        
        .success-message {
            color: var(--emerald-green);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            font-weight: 600;
        }
        
        /* Order Summary */
        .order-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 2rem;
        }
        
        .order-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid rgba(212, 175, 55, 0.2);
            border-radius: 15px;
            margin-bottom: 1rem;
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .item-image {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid var(--gold-primary);
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-title {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.3;
            margin-bottom: 0.3rem;
        }
        
        .item-price {
            font-weight: 800;
            background: var(--gradient-gold);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .item-quantity {
            font-weight: 800;
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        /* Price Summary */
        .price-summary {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--gold-light);
            margin-bottom: 2rem;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .price-row.total {
            font-size: 1.5rem;
            font-weight: 900;
            padding: 1.5rem 0;
            border-top: 3px solid var(--gold-primary);
            margin-top: 1.5rem;
        }
        
        .price-label {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .price-value {
            background: var(--gradient-gold);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }
        
        .free-badge {
            color: var(--emerald-green);
            font-weight: 800;
        }
        
        /* Submit Button */
        .submit-button {
            width: 100%;
            padding: 1.8rem;
            background: var(--gradient-emerald);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1.4rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 30px rgba(80, 200, 120, 0.4);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .submit-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.6s ease;
            z-index: 1;
        }
        
        .submit-button:hover::before {
            width: 600px;
            height: 600px;
        }
        
        .submit-button:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 20px 60px rgba(80, 200, 120, 0.6);
            background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, #9CA3AF, #6B7280);
        }
        
        /* Legal Agreement */
        .legal-agreement {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid var(--gold-light);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 2rem 0;
            text-align: center;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .legal-agreement a {
            color: var(--gold-primary);
            text-decoration: none;
            font-weight: 700;
            border-bottom: 1px dotted var(--gold-primary);
        }
        
        .legal-agreement a:hover {
            color: var(--emerald-green);
            border-bottom-color: var(--emerald-green);
        }
        
        /* Order Number Display */
        .order-number {
            background: var(--gradient-royal);
            color: white;
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            margin: 2rem 0;
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.4);
            border: 3px solid rgba(255, 255, 255, 0.3);
            display: none;
        }
        
        .order-number h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 800;
        }
        
        .order-id {
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: 2px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* Success Animation */
        .success-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            background: var(--gradient-emerald);
            color: white;
            padding: 3rem;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 15px 50px rgba(80, 200, 120, 0.5);
            animation: successPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: none;
        }
        
        @keyframes successPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .checkout-container {
                grid-template-columns: 1fr;
                gap: 2rem;
                padding: 0 1rem;
            }
            
            .checkout-summary {
                position: static;
                order: -1;
            }
            
            .checkout-form {
                padding: 2rem;
            }
            
            .page-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/b1f430c1-8aa0-4082-8bec-59935fddfaa2.png" alt="سوق الإمارات" style="height: 45px; width: auto; margin-left: 16px;">
                    <span>سوق الإمارات</span>
                </div>
                
                <nav class="nav">
                    <ul class="nav-list">
                        <li><a href="./" target="_blank" rel="noopener">🏠 الرئيسية</a></li>
                        <li><a href="cart.html" target="_blank" rel="noopener">🛒 السلة</a></li>
                        <li><a href="legal/terms.html" target="_blank" rel="noopener">📋 الشروط</a></li>
                        <li><a href="legal/privacy.html" target="_blank" rel="noopener">🔒 الخصوصية</a></li>
                        <li><a href="legal/shipping.html" target="_blank" rel="noopener">📦 الشحن</a></li>
                        <li><a href="legal/returns.html" target="_blank" rel="noopener">↩️ الإرجاع</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="checkout-page">
        <div class="checkout-container">
            <!-- Checkout Form -->
            <div class="checkout-form">
                <h1 class="page-title">💳 إتمام الطلب</h1>
                
                <div class="security-badge">
                    🔒 <span>بياناتك آمنة بتقنية SSL 256-bit</span>
                </div>
                
                <form id="checkout-form">
                    <!-- Customer Information -->
                    <div class="form-section">
                        <h2 class="section-title">👤 بيانات العميل</h2>
                        
                        <div class="form-group">
                            <label for="customer-name" class="form-label">
                                الاسم الكامل <span class="required">*</span>
                            </label>
                            <input type="text" 
                                   id="customer-name" 
                                   name="customer-name" 
                                   class="form-input" 
                                   placeholder="أدخل اسمك الكامل بالعربية" 
                                   required 
                                   autocomplete="name">
                            <div class="error-message" id="name-error"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="customer-phone" class="form-label">
                                رقم الهاتف الإماراتي <span class="required">*</span>
                            </label>
                            <input type="tel" 
                                   id="customer-phone" 
                                   name="customer-phone" 
                                   class="form-input" 
                                   placeholder="971501234567" 
                                   pattern="^971(50|51|52|54|55|56|58)\d{7}$"
                                   required 
                                   autocomplete="tel">
                            <div class="success-message" style="font-size: 0.85rem; margin-top: 0.3rem;">
                                ℹ️ مثال: 971501234567 (يجب أن يبدأ بـ 971)
                            </div>
                            <div class="error-message" id="phone-error"></div>
                        </div>
                    </div>
                    
                    <!-- Delivery Address -->
                    <div class="form-section">
                        <h2 class="section-title">📦 عنوان التوصيل</h2>
                        
                        <div class="form-group">
                            <label for="delivery-address" class="form-label">
                                العنوان الكامل <span class="required">*</span>
                            </label>
                            <textarea id="delivery-address" 
                                      name="delivery-address" 
                                      class="form-input" 
                                      rows="3" 
                                      placeholder="اسم الإمارة + المدينة + المنطقة + اسم الشارع + رقم المبنى\nمثال: دبي - مارينا مول - شارع الشيخ زايد - مبنى رقم 123 - شقة 45" 
                                      required 
                                      autocomplete="street-address"></textarea>
                            <div class="error-message" id="address-error"></div>
                        </div>
                    </div>
                    
                    <!-- Order Notes (Optional) -->
                    <div class="form-section">
                        <h2 class="section-title">📝 ملاحظات الطلب (اختياري)</h2>
                        
                        <div class="form-group">
                            <textarea id="order-notes" 
                                      name="order-notes" 
                                      class="form-input" 
                                      rows="2" 
                                      placeholder="ملاحظات إضافية (اختياري)\nمثال: اتصال قبل التوصيل، التوصيل في وقت محدد، إلخ..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Legal Agreement -->
                    <div class="legal-agreement">
                        <p>بالضغط على زر "إرسال الطلب" أنت توافق على:</p>
                        <div style="margin: 1rem 0; display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                            <a href="legal/terms.html" target="_blank" rel="noopener">📋 الشروط والأحكام</a>
                            <a href="legal/privacy.html" target="_blank" rel="noopener">🔒 سياسة الخصوصية</a>
                            <a href="legal/shipping.html" target="_blank" rel="noopener">📦 سياسة الشحن</a>
                            <a href="legal/returns.html" target="_blank" rel="noopener">↩️ سياسة الإرجاع</a>
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-button" id="submit-order">
                        🚀 إرسال الطلب عبر واتساب
                    </button>
                </form>
                
                <!-- Order Number Display -->
                <div class="order-number" id="order-number-display">
                    <h3>🎉 تم إرسال طلبك بنجاح!</h3>
                    <p>رقم طلبك هو:</p>
                    <div class="order-id" id="generated-order-id"></div>
                    <p style="margin-top: 1rem; font-size: 0.95rem; opacity: 0.9;">
                        احتفظ بهذا الرقم لمتابعة طلبك
                    </p>
                </div>
            </div>
            
            <!-- Order Summary -->
            <div class="checkout-summary">
                <h2 style="
                    font-size: 1.8rem; 
                    font-weight: 800; 
                    background: var(--gradient-royal); 
                    background-clip: text; 
                    -webkit-background-clip: text; 
                    -webkit-text-fill-color: transparent; 
                    text-align: center; 
                    margin-bottom: 2rem;
                ">
                    📋 ملخص طلبك
                </h2>
                
                <!-- Cart Items -->
                <div class="order-items" id="order-items">
                    <div class="loading" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🛒</div>
                        <h4>جاري تحميل عناصر الطلب...</h4>
                    </div>
                </div>
                
                <!-- Price Breakdown -->
                <div class="price-summary">
                    <div class="price-row">
                        <span class="price-label">عدد العناصر:</span>
                        <span class="price-value" id="items-count">0 عنصر</span>
                    </div>
                    
                    <div class="price-row">
                        <span class="price-label">إجمالي المنتجات:</span>
                        <span class="price-value" id="subtotal">0 درهم</span>
                    </div>
                    
                    <div class="price-row">
                        <span class="price-label">رسوم الشحن:</span>
                        <span class="free-badge">مجاني 🎁</span>
                    </div>
                    
                    <div class="price-row">
                        <span class="price-label">ضريبة القيمة المضافة (5%):</span>
                        <span class="price-value" id="vat-amount">0 درهم</span>
                    </div>
                    
                    <div class="price-row total">
                        <span class="price-label">المجموع النهائي:</span>
                        <span class="price-value" id="final-total">0 درهم</span>
                    </div>
                </div>
                
                <!-- Service Guarantees -->
                <div style="
                    background: rgba(80, 200, 120, 0.1); 
                    border: 2px solid var(--emerald-green); 
                    border-radius: 15px; 
                    padding: 1.5rem; 
                    text-align: center;
                    margin-top: 2rem;
                ">
                    <h4 style="color: var(--emerald-green); margin-bottom: 1rem; font-weight: 700;">✅ ضمانات الأمان</h4>
                    <div style="font-size: 0.9rem; color: var(--emerald-green); font-weight: 600; line-height: 1.6;">
                        🚚 شحن مجاني 100%<br>
                        💰 دفع آمن عند الاستلام<br>
                        🔄 ضمان إرجاع 7 أيام<br>
                        ⭐ خدمة عملاء 24/7<br>
                        🇦🇪 ضمان الجودة الإماراتية
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>🏪 سوق الإمارات</h3>
                    <p>رائدون في عالم التسوق الرقمي بأسلوب الفخامة الإماراتي</p>
                    <p>منتج إماراتي 100% 🇦🇪</p>
                </div>
                <div class="footer-section">
                    <h3>🔗 روابط مهمة</h3>
                    <div>
                        <a href="legal/terms.html" target="_blank" rel="noopener">📋 الشروط</a><br>
                        <a href="legal/privacy.html" target="_blank" rel="noopener">🔒 الخصوصية</a><br>
                        <a href="legal/shipping.html" target="_blank" rel="noopener">📦 الشحن</a><br>
                        <a href="legal/returns.html" target="_blank" rel="noopener">↩️ الإرجاع</a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>📞 تواصل معنا</h3>
                    <div>
                        <a href="https://wa.me/201110760081" target="_blank" rel="noopener">📱 واتساب</a><br>
                        <a href="tel:+201110760081">☎️ اتصال</a><br>
                        <a href="mailto:info@sooq-alemarat.com">📧 بريد</a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>✨ خدماتنا</h3>
                    <div>
                        <span>🚚 شحن مجاني</span><br>
                        <span>💰 دفع عند الاستلام</span><br>
                        <span>🔄 ضمان إرجاع</span><br>
                        <span>⭐ دعم 24/7</span>
                    </div>
                </div>
            </div>
            <div style="border-top: 1px solid #8B4513; padding-top: 2rem; margin-top: 2rem;">
                <p>&copy; 2025 سوق الإمارات. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>

    <!-- WhatsApp Float -->
    <a href="https://wa.me/201110760081" class="whatsapp-float" target="_blank" rel="noopener">
        📱
    </a>

    <!-- Success Animation -->
    <div class="success-animation" id="success-animation">
        <div style="font-size: 4rem; margin-bottom: 1rem;">🎉</div>
        <h3>تم إرسال طلبك بنجاح!</h3>
        <p>سيتم التواصل معك قريباً</p>
    </div>

    <script>
        class CheckoutPage {
            constructor() {
                this.cartItems = [];
                this.subtotal = 0;
                this.vatRate = 0.05; // 5% VAT for UAE
                this.shipping = 0; // Free shipping
                
                this.init();
            }
            
            init() {
                this.loadCartItems();
                this.renderOrderSummary();
                this.setupFormValidation();
                this.setupFormSubmission();
            }
            
            loadCartItems() {
                try {
                    const saved = localStorage.getItem('emirates_cart');
                    this.cartItems = saved ? JSON.parse(saved) : [];
                    console.log(`📋 تم تحميل ${this.cartItems.length} عنصر في الطلب`);
                } catch (error) {
                    console.error('خطأ في تحميل عناصر السلة:', error);
                    this.cartItems = [];
                }
            }
            
            renderOrderSummary() {
                const container = document.getElementById('order-items');
                if (!container) return;
                
                if (this.cartItems.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">🛒</div>
                            <h4>لا توجد منتجات في الطلب</h4>
                            <p>يرجى إضافة منتجات قبل إتمام الطلب</p>
                            <a href="./" style="
                                display: inline-block;
                                margin-top: 1rem;
                                padding: 0.8rem 1.5rem;
                                background: var(--gradient-gold);
                                color: white;
                                text-decoration: none;
                                border-radius: 15px;
                                font-weight: 700;
                                transition: all 0.3s ease;
                            " target="_blank">🏠 اذهب للمتجر</a>
                        </div>
                    `;
                    this.disableSubmit();
                    return;
                }
                
                // Render items
                const itemsHTML = this.cartItems.map(item => `
                    <div class="order-item">
                        <img class="item-image" src="${item.image}" alt="${item.title}" 
                             onerror="this.src='https://via.placeholder.com/60x60/D4AF37/FFFFFF?text=صورة'">
                        <div class="item-details">
                            <div class="item-title">${item.title.length > 40 ? item.title.substring(0, 40) + '...' : item.title}</div>
                            <div class="item-price">${(item.price || 0) * (item.quantity || 1)} درهم</div>
                        </div>
                        <div class="item-quantity">×${item.quantity || 1}</div>
                    </div>
                `).join('');
                
                container.innerHTML = itemsHTML;
                
                // Calculate totals
                this.calculateTotals();
                this.enableSubmit();
            }
            
            calculateTotals() {
                const itemsCount = this.cartItems.reduce((total, item) => total + (item.quantity || 1), 0);
                this.subtotal = this.cartItems.reduce((total, item) => total + ((item.price || 0) * (item.quantity || 1)), 0);
                const vatAmount = Math.round(this.subtotal * this.vatRate);
                const finalTotal = this.subtotal + vatAmount + this.shipping;
                
                // Update display
                document.getElementById('items-count').textContent = `${itemsCount} عنصر`;
                document.getElementById('subtotal').textContent = `${this.subtotal} درهم`;
                document.getElementById('vat-amount').textContent = `${vatAmount} درهم`;
                document.getElementById('final-total').textContent = `${finalTotal} درهم`;
            }
            
            setupFormValidation() {
                const nameInput = document.getElementById('customer-name');
                const phoneInput = document.getElementById('customer-phone');
                const addressInput = document.getElementById('delivery-address');
                
                // Name validation
                if (nameInput) {
                    nameInput.addEventListener('blur', () => {
                        this.validateName(nameInput);
                    });
                }
                
                // Phone validation with UAE format
                if (phoneInput) {
                    phoneInput.addEventListener('input', (e) => {
                        // Allow only numbers and limit length
                        let value = e.target.value.replace(/\D/g, '');
                        
                        // Auto-add 971 prefix if user starts typing without it
                        if (value.length > 0 && !value.startsWith('971')) {
                            if (value.startsWith('50') || value.startsWith('51') || 
                                value.startsWith('52') || value.startsWith('54') || 
                                value.startsWith('55') || value.startsWith('56') || 
                                value.startsWith('58')) {
                                value = '971' + value;
                            }
                        }
                        
                        // Limit to 12 digits (971 + 9 digits)
                        if (value.length > 12) {
                            value = value.substring(0, 12);
                        }
                        
                        e.target.value = value;
                    });
                    
                    phoneInput.addEventListener('blur', () => {
                        this.validatePhone(phoneInput);
                    });
                }
                
                // Address validation
                if (addressInput) {
                    addressInput.addEventListener('blur', () => {
                        this.validateAddress(addressInput);
                    });
                }
            }
            
            validateName(input) {
                const name = input.value.trim();
                const errorElement = document.getElementById('name-error');
                
                if (name.length < 2) {
                    this.showFieldError(input, errorElement, 'يجب أن يكون الاسم حرفين على الأقل');
                    return false;
                }
                
                if (!/^[\u0600-\u06FF\u0750-\u077F\s]+$/.test(name)) {
                    this.showFieldError(input, errorElement, 'يجب إدخال الاسم بالعربية فقط');
                    return false;
                }
                
                this.showFieldSuccess(input, errorElement, '✅ اسم صحيح');
                return true;
            }
            
            validatePhone(input) {
                const phone = input.value.trim();
                const errorElement = document.getElementById('phone-error');
                
                // UAE phone number validation
                const uaePhoneRegex = /^971(50|51|52|54|55|56|58)\d{7}$/;
                
                if (!uaePhoneRegex.test(phone)) {
                    this.showFieldError(input, errorElement, 'رقم هاتف إماراتي غير صحيح. يجب أن يبدأ بـ 971');
                    return false;
                }
                
                this.showFieldSuccess(input, errorElement, '✅ رقم هاتف صحيح');
                return true;
            }
            
            validateAddress(input) {
                const address = input.value.trim();
                const errorElement = document.getElementById('address-error');
                
                if (address.length < 10) {
                    this.showFieldError(input, errorElement, 'يرجى إدخال عنوان مفصل لضمان التوصيل الصحيح');
                    return false;
                }
                
                // Check for UAE emirates
                const uaeEmirates = ['دبي', 'أبوظبي', 'الشارقة', 'عجمان', 'رأس الخيمة', 'أم القيوين', 'الفجيرة', 'Dubai', 'Abu Dhabi', 'Sharjah', 'Ajman', 'Ras Al Khaimah', 'Umm Al Quwain', 'Fujairah'];
                const hasEmirate = uaeEmirates.some(emirate => address.includes(emirate));
                
                if (!hasEmirate) {
                    this.showFieldError(input, errorElement, 'يرجى ذكر اسم الإمارة في العنوان');
                    return false;
                }
                
                this.showFieldSuccess(input, errorElement, '✅ عنوان صحيح');
                return true;
            }
            
            showFieldError(input, errorElement, message) {
                input.classList.add('error');
                input.classList.remove('success');
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.color = '#EF4444';
                }
            }
            
            showFieldSuccess(input, errorElement, message) {
                input.classList.remove('error');
                input.classList.add('success');
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.color = 'var(--emerald-green)';
                }
            }
            
            setupFormSubmission() {
                const form = document.getElementById('checkout-form');
                if (!form) return;
                
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleFormSubmission();
                });
            }
            
            setupFormValidation() {
                // تفعيل التحقق في الوقت الفعلي
                const nameInput = document.getElementById('customer-name');
                const phoneInput = document.getElementById('customer-phone');
                const addressInput = document.getElementById('delivery-address');
                
                [nameInput, phoneInput, addressInput].forEach(input => {
                    if (input) {
                        input.addEventListener('input', () => {
                            this.clearFieldError(input);
                        });
                    }
                });
            }
            
            clearFieldError(input) {
                input.classList.remove('error');
                const errorId = input.id + '-error';
                const errorElement = document.getElementById(errorId);
                if (errorElement) {
                    errorElement.textContent = '';
                }
            }
            
            async handleFormSubmission() {
                // تحقق من وجود عناصر في الطلب
                if (this.cartItems.length === 0) {
                    this.showNotification('لا يمكن إرسال طلب فارغ!', 'error');
                    return;
                }
                
                // تحقق من صحة البيانات
                const nameValid = this.validateName(document.getElementById('customer-name'));
                const phoneValid = this.validatePhone(document.getElementById('customer-phone'));
                const addressValid = this.validateAddress(document.getElementById('delivery-address'));
                
                if (!nameValid || !phoneValid || !addressValid) {
                    this.showNotification('يرجى تصحيح البيانات المميزة بالأحمر', 'error');
                    return;
                }
                
                // بدء عملية الإرسال
                this.disableSubmit('🚀 جاري إعداد الطلب...');
                
                try {
                    // توليد رقم طلب فريد
                    const orderNumber = this.generateOrderNumber();
                    
                    // تجميع بيانات الطلب
                    const orderData = this.collectOrderData(orderNumber);
                    
                    // إرسال عبر واتساب
                    await this.sendWhatsAppOrder(orderData);
                    
                    // عرض رقم الطلب
                    this.showOrderNumber(orderNumber);
                    
                    // تنظيف السلة
                    this.clearCartAfterOrder();
                    
                } catch (error) {
                    console.error('خطأ في إرسال الطلب:', error);
                    this.showNotification('حدث خطأ في إرسال الطلب. يرجى المحاولة مرة أخرى', 'error');
                    this.enableSubmit();
                }
            }
            
            generateOrderNumber() {
                const timestamp = Date.now().toString(36).toUpperCase();
                const random = Math.random().toString(36).substr(2, 4).toUpperCase();
                return `UAE-${timestamp}-${random}`;
            }
            
            collectOrderData(orderNumber) {
                const name = document.getElementById('customer-name').value.trim();
                const phone = document.getElementById('customer-phone').value.trim();
                const address = document.getElementById('delivery-address').value.trim();
                const notes = document.getElementById('order-notes').value.trim();
                
                const subtotal = this.subtotal;
                const vatAmount = Math.round(subtotal * this.vatRate);
                const finalTotal = subtotal + vatAmount;
                
                return {
                    orderNumber,
                    customer: { name, phone, address, notes },
                    items: this.cartItems,
                    pricing: { subtotal, vatAmount, shipping: this.shipping, finalTotal },
                    timestamp: new Date().toLocaleString('ar-AE', {
                        timeZone: 'Asia/Dubai',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                };
            }
            
            async sendWhatsAppOrder(orderData) {
                // إعداد رسالة واتساب مفصلة
                const itemsList = orderData.items.map(item => 
                    `• ${item.title} - ${(item.price || 0) * (item.quantity || 1)} درهم (×${item.quantity || 1})`
                ).join('\n');
                
                const message = `🎆 طلب جديد من سوق الإمارات 🎆

📋 رقم الطلب: ${orderData.orderNumber}
📅 التاريخ: ${orderData.timestamp}

👤 بيانات العميل:
• الاسم: ${orderData.customer.name}
• الهاتف: ${orderData.customer.phone}
• العنوان: ${orderData.customer.address}
${orderData.customer.notes ? `• ملاحظات: ${orderData.customer.notes}` : ''}

🛒 قائمة المنتجات:
${itemsList}

💰 تفاصيل السعر:
• إجمالي المنتجات: ${orderData.pricing.subtotal} درهم
• ضريبة القيمة المضافة (5%): ${orderData.pricing.vatAmount} درهم
• رسوم الشحن: مجاني 🎁
• المجموع النهائي: ${orderData.pricing.finalTotal} درهم

🚚 طريقة الدفع: دفع عند الاستلام (COD)

يرجى تأكيد استلام الطلب وإعلامنا بوقت التوصيل المناسب.

شكراً لاختياركم سوق الإمارات 🇦🇪`;
                
                // فتح واتساب في تبويب جديد
                const whatsappUrl = `https://wa.me/201110760081?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
                
                return true;
            }
            
            showOrderNumber(orderNumber) {
                // عرض رقم الطلب
                document.getElementById('generated-order-id').textContent = orderNumber;
                document.getElementById('order-number-display').style.display = 'block';
                
                // عرض رسالة نجاح
                const successAnimation = document.getElementById('success-animation');
                successAnimation.style.display = 'block';
                
                setTimeout(() => {
                    successAnimation.style.display = 'none';
                }, 3000);
                
                // حفظ رقم الطلب في التخزين المحلي
                const orderHistory = JSON.parse(localStorage.getItem('emirates_orders') || '[]');
                orderHistory.push({
                    orderNumber,
                    timestamp: Date.now(),
                    total: this.subtotal + Math.round(this.subtotal * this.vatRate)
                });
                localStorage.setItem('emirates_orders', JSON.stringify(orderHistory));
                
                this.showNotification(`تم إرسال طلبك بنجاح! رقم الطلب: ${orderNumber}`, 'success');
            }
            
            clearCartAfterOrder() {
                localStorage.removeItem('emirates_cart');
                
                // تحديث عرض السلة إذا كانت متاحة
                if (window.cart && typeof window.cart.updateCartDisplay === 'function') {
                    window.cart.items = [];
                    window.cart.updateCartDisplay();
                }
            }
            
            enableSubmit() {
                const btn = document.getElementById('submit-order');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '🚀 إرسال الطلب عبر واتساب';
                    btn.style.opacity = '1';
                }
            }
            
            disableSubmit(text = 'يرجى إضافة منتجات أولاً') {
                const btn = document.getElementById('submit-order');
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = text;
                    btn.style.opacity = '0.6';
                }
            }
            
            showNotification(message, type = 'success') {
                const colors = {
                    success: '#50C878',
                    error: '#FF6B6B',
                    info: '#87CEEB'
                };
                
                // إزالة الإشعارات السابقة
                document.querySelectorAll('.checkout-notification').forEach(n => n.remove());
                
                const notification = document.createElement('div');
                notification.className = 'checkout-notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 120px;
                    right: 24px;
                    background: ${colors[type]};
                    color: white;
                    padding: 1.2rem 1.8rem;
                    border-radius: 20px;
                    font-weight: 700;
                    z-index: 10001;
                    animation: slideIn 0.4s ease;
                    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
                    cursor: pointer;
                    max-width: 350px;
                `;
                notification.textContent = message;
                
                notification.addEventListener('click', () => notification.remove());
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) notification.remove();
                }, 5000);
            }
        }
        
        // تفعيل نظام إتمام الطلب
        let checkoutPage;
        document.addEventListener('DOMContentLoaded', function() {
            checkoutPage = new CheckoutPage();
            console.log('✅ تم تفعيل صفحة إتمام الطلب بنجاح');
        });
        
        // أنماط الحركة
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { opacity: 0; transform: translateX(100px); }
                to { opacity: 1; transform: translateX(0); }
            }
            
            .form-input.success {
                border-color: var(--emerald-green);
                box-shadow: 0 0 15px rgba(80, 200, 120, 0.3);
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>